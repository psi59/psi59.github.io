<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>AWS Lambda 로컬 디버깅 (provided.al2 Runtime) | Sangil's Blog</title><meta name=keywords content="golang,docker,aws,lambda"><meta name=description content="이 포스트는 2023-12-31부터 go1.x 런타임이 deprecate 됨에 따라 provided.al2 런타임으로 마이그레이트한 람다 함수를 로컬에서 디버깅하는 방법에 대해 포스팅한 내용임."><meta name=author content="박상일"><link rel=canonical href=https://blog.psi59.com/posts/2023-10-21-lambda-local-debugging/><link crossorigin=anonymous href=/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe+FVUFzPh7U=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.psi59.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.psi59.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.psi59.com/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.psi59.com/apple-touch-icon.png><link rel=mask-icon href=https://blog.psi59.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-MMTYEB98J6"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-MMTYEB98J6",{anonymize_ip:!1})}</script><meta property="og:title" content="AWS Lambda 로컬 디버깅 (provided.al2 Runtime)"><meta property="og:description" content="이 포스트는 2023-12-31부터 go1.x 런타임이 deprecate 됨에 따라 provided.al2 런타임으로 마이그레이트한 람다 함수를 로컬에서 디버깅하는 방법에 대해 포스팅한 내용임."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.psi59.com/posts/2023-10-21-lambda-local-debugging/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-10-21T03:05:07+09:00"><meta property="article:modified_time" content="2023-10-21T03:05:07+09:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="AWS Lambda 로컬 디버깅 (provided.al2 Runtime)"><meta name=twitter:description content="이 포스트는 2023-12-31부터 go1.x 런타임이 deprecate 됨에 따라 provided.al2 런타임으로 마이그레이트한 람다 함수를 로컬에서 디버깅하는 방법에 대해 포스팅한 내용임."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://blog.psi59.com/posts/"},{"@type":"ListItem","position":3,"name":"AWS Lambda 로컬 디버깅 (provided.al2 Runtime)","item":"https://blog.psi59.com/posts/2023-10-21-lambda-local-debugging/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"AWS Lambda 로컬 디버깅 (provided.al2 Runtime)","name":"AWS Lambda 로컬 디버깅 (provided.al2 Runtime)","description":"이 포스트는 2023-12-31부터 go1.x 런타임이 deprecate 됨에 따라 provided.al2 런타임으로 마이그레이트한 람다 함수를 로컬에서 디버깅하는 방법에 대해 포스팅한 내용임.\n","keywords":["golang","docker","aws","lambda"],"articleBody":"이 포스트는 2023-12-31부터 go1.x 런타임이 deprecate 됨에 따라 provided.al2 런타임으로 마이그레이트한 람다 함수를 로컬에서 디버깅하는 방법에 대해 포스팅한 내용임.\nDocker Image 생성 아래 스크립트는 람다 컨테이너 이미지다.\nFROM golang:1.21-alpine as builder WORKDIR /usr/src/app COPY . . RUN go install github.com/go-delve/delve/cmd/dlv@latest RUN go mod vendor RUN\tGOOS=linux GOARCH=arm64 go build -gcflags=\"all=-N -l\" -tags lambda.norpc -o /usr/src/app/main . FROM public.ecr.aws/lambda/provided:al2 RUN mkdir /www COPY --from=builder /usr/src/app/main /usr/bin/main COPY --from=builder /go/bin/dlv /usr/bin/dlv EXPOSE 2345 ENTRYPOINT [\"/usr/bin/\"] AWS에서 게재한 예시와 차이점은 dlv를 추가한 것과 Go 바이너리 빌드시 -gcflags=\"all=-N -l\" 플래그를 추가했다는 점이다.\n# 도커 이미지 빌드 docker build -t lambda-test . 로컬에서 디버깅 # 도커 컨테이너 실행 docker run --rm --name lambda-test \\ -v ~/.aws-lambda-rie:/aws-lambda \\ -p 9000:8080 -p 2345:2345 \\ --entrypoint /aws-lambda/aws-lambda-rie \\ lambda-test \\ /usr/bin/dlv --listen=:2345 --headless=true --api-version=2 --accept-multiclient exec /usr/bin/main --continue # 바이너리에 추가로 플래그를 추가해야할 경우 {your-flag} 자리에 필요한 플래그를 추가하면 된다. docker run --rm --name lambda-test \\ -v ~/.aws-lambda-rie:/aws-lambda \\ -p 9000:8080 -p 2345:2345 \\ --entrypoint /aws-lambda/aws-lambda-rie \\ lambda-test \\ /usr/bin/dlv --listen=:2345 --headless=true --api-version=2 --accept-multiclient exec /usr/bin/main --continue -- {your-flag} 위 명령어에서 볼륨으로 연결하는 ~/.aws-lambda-rie 폴더는 링크를 통해서 환경에 맞게 설치하면 홈폴더 아래에 설치된다.\n명령어를 실행하여 컨테이너를 띄우고 IDE에 remote 디버깅을 위한 환경을 세팅한다. 이 포스트는 jetbrains의 IDE를 기준으로 작성되었다.\nRun/Debug Configurations에서 go remote를 세팅해준다.\n2345 포트를 세팅한 후 실행한다.\n# 테스트 요청 curl -XPOST \"http://localhost:9000/2015-03-31/functions/function/invocations\" -d '{}' # 파일로 저장된 이벤트 요청 curl -XPOST \"http://localhost:9000/2015-03-31/functions/function/invocations\" -d @your_file_name.json References https://aws.amazon.com/ko/blogs/compute/migrating-aws-lambda-functions-from-the-go1-x-runtime-to-the-custom-runtime-on-amazon-linux-2/ https://docs.aws.amazon.com/ko_kr/lambda/latest/dg/go-image.html#go-image-clients https://mingrammer.com/debugging-containerized-go-app/#%EB%94%94%EB%B2%84%EA%B9%85-%EC%9D%B4%EB%AF%B8%EC%A7%80 ","wordCount":"233","inLanguage":"en","datePublished":"2023-10-21T03:05:07+09:00","dateModified":"2023-10-21T03:05:07+09:00","author":{"@type":"Person","name":"박상일"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.psi59.com/posts/2023-10-21-lambda-local-debugging/"},"publisher":{"@type":"Organization","name":"Sangil's Blog","logo":{"@type":"ImageObject","url":"https://blog.psi59.com/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://blog.psi59.com accesskey=h title="Sangil's Blog (Alt + H)">Sangil's Blog</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://blog.psi59.com/posts/ title=posts><span>posts</span></a></li><li><a href=https://blog.psi59.com/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.psi59.com>Home</a>&nbsp;»&nbsp;<a href=https://blog.psi59.com/posts/>Posts</a></div><h1 class=post-title>AWS Lambda 로컬 디버깅 (provided.al2 Runtime)</h1><div class=post-meta><span title='2023-10-21 03:05:07 +0900 +0900'>October 21, 2023</span>&nbsp;·&nbsp;2 min&nbsp;·&nbsp;박상일</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#docker-image-%ec%83%9d%ec%84%b1 aria-label="Docker Image 생성">Docker Image 생성</a></li><li><a href=#%eb%a1%9c%ec%bb%ac%ec%97%90%ec%84%9c-%eb%94%94%eb%b2%84%ea%b9%85 aria-label="로컬에서 디버깅">로컬에서 디버깅</a></li><li><a href=#references aria-label=References>References</a></li></ul></div></details></div><div class=post-content><p>이 포스트는 2023-12-31부터 <code>go1.x</code> 런타임이 deprecate 됨에 따라 <code>provided.al2</code> 런타임으로 마이그레이트한 람다 함수를 로컬에서 디버깅하는 방법에 대해 포스팅한 내용임.</p><h2 id=docker-image-생성>Docker Image 생성<a hidden class=anchor aria-hidden=true href=#docker-image-생성>#</a></h2><p>아래 스크립트는 람다 컨테이너 이미지다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> golang:1.21-alpine as builder</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /usr/src/app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> . .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> go install github.com/go-delve/delve/cmd/dlv@latest<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> go mod vendor<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span>	GOOS<span style=color:#f92672>=</span>linux GOARCH<span style=color:#f92672>=</span>arm64 go build -gcflags<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;all=-N -l&#34;</span> -tags lambda.norpc -o /usr/src/app/main .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> public.ecr.aws/lambda/provided:al2</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> mkdir /www<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>builder /usr/src/app/main /usr/bin/main<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>builder /go/bin/dlv /usr/bin/dlv<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 2345</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> [<span style=color:#e6db74>&#34;/usr/bin/&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>AWS에서 게재한 예시와 차이점은 dlv를 추가한 것과 Go 바이너리 빌드시 <code>-gcflags="all=-N -l"</code> 플래그를 추가했다는 점이다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># 도커 이미지 빌드</span>
</span></span><span style=display:flex><span>docker build -t lambda-test .
</span></span></code></pre></div><h2 id=로컬에서-디버깅>로컬에서 디버깅<a hidden class=anchor aria-hidden=true href=#로컬에서-디버깅>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># 도커 컨테이너 실행</span>
</span></span><span style=display:flex><span>docker run --rm --name lambda-test <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	-v ~/.aws-lambda-rie:/aws-lambda <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	-p 9000:8080 -p 2345:2345 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --entrypoint /aws-lambda/aws-lambda-rie <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    lambda-test <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    /usr/bin/dlv --listen<span style=color:#f92672>=</span>:2345 --headless<span style=color:#f92672>=</span>true --api-version<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> --accept-multiclient exec /usr/bin/main --continue
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 바이너리에 추가로 플래그를 추가해야할 경우 {your-flag} 자리에 필요한 플래그를 추가하면 된다.</span>
</span></span><span style=display:flex><span>docker run --rm --name lambda-test <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	-v ~/.aws-lambda-rie:/aws-lambda <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	-p 9000:8080 -p 2345:2345 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --entrypoint /aws-lambda/aws-lambda-rie <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    lambda-test <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    /usr/bin/dlv --listen<span style=color:#f92672>=</span>:2345 --headless<span style=color:#f92672>=</span>true --api-version<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> --accept-multiclient exec /usr/bin/main --continue -- <span style=color:#f92672>{</span>your-flag<span style=color:#f92672>}</span>
</span></span></code></pre></div><p>위 명령어에서 볼륨으로 연결하는 <code>~/.aws-lambda-rie</code> 폴더는 <a href=https://github.com/aws/aws-lambda-runtime-interface-emulator#installing>링크</a>를 통해서 환경에 맞게 설치하면 홈폴더 아래에 설치된다.</p><p>명령어를 실행하여 컨테이너를 띄우고 IDE에 remote 디버깅을 위한 환경을 세팅한다.
이 포스트는 jetbrains의 IDE를 기준으로 작성되었다.</p><p><code>Run/Debug Configurations</code>에서 go remote를 세팅해준다.</p><p><img loading=lazy src=/images/2023-10-20-lambda-local-debugging/6D928A39-C1D8-4778-B382-F43218630D68.png alt="run configuration"></p><p>2345 포트를 세팅한 후 실행한다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># 테스트 요청</span>
</span></span><span style=display:flex><span>curl -XPOST <span style=color:#e6db74>&#34;http://localhost:9000/2015-03-31/functions/function/invocations&#34;</span> -d <span style=color:#e6db74>&#39;{}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 파일로 저장된 이벤트 요청</span>
</span></span><span style=display:flex><span>curl -XPOST <span style=color:#e6db74>&#34;http://localhost:9000/2015-03-31/functions/function/invocations&#34;</span> -d @your_file_name.json
</span></span></code></pre></div><h2 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h2><ul><li><a href=https://aws.amazon.com/ko/blogs/compute/migrating-aws-lambda-functions-from-the-go1-x-runtime-to-the-custom-runtime-on-amazon-linux-2/>https://aws.amazon.com/ko/blogs/compute/migrating-aws-lambda-functions-from-the-go1-x-runtime-to-the-custom-runtime-on-amazon-linux-2/</a></li><li><a href=https://docs.aws.amazon.com/ko_kr/lambda/latest/dg/go-image.html#go-image-clients>https://docs.aws.amazon.com/ko_kr/lambda/latest/dg/go-image.html#go-image-clients</a></li><li><a href=https://mingrammer.com/debugging-containerized-go-app/#%EB%94%94%EB%B2%84%EA%B9%85-%EC%9D%B4%EB%AF%B8%EC%A7%80>https://mingrammer.com/debugging-containerized-go-app/#%EB%94%94%EB%B2%84%EA%B9%85-%EC%9D%B4%EB%AF%B8%EC%A7%80</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.psi59.com/tags/golang/>golang</a></li><li><a href=https://blog.psi59.com/tags/docker/>docker</a></li><li><a href=https://blog.psi59.com/tags/aws/>aws</a></li><li><a href=https://blog.psi59.com/tags/lambda/>lambda</a></li></ul><nav class=paginav><a class=next href=https://blog.psi59.com/posts/2023-10-20-lambda-local-debugging/><span class=title>Next »</span><br><span>AWS Lambda 로컬 디버깅 (Go1.x Runtime)</span></a></nav></footer><script src=https://utteranc.es/client.js repo=psi59/psi59.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2023 <a href=https://blog.psi59.com>Sangil's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>