---
title: "[Real MySQL 8.0] #4-1 아키텍쳐"
tags: ["mysql", "real-mysql"]
date: 2021-12-03T15:34:00+09:00
cover:
    image: /images/covers/real-mysql-8-0.png
draft: true
---

Real MySQL 4장 아키텍쳐를 보고 정리한 내용이며 스토리지 엔진 부분은 일반적으로 가장 많이 사용하는 InnoDB 기준으로 정리 하였습니다.

<!--more-->

## MySQL 엔진 아키텍쳐

### MySQL의 전체 구조

![architecture](/images/2021-12-13-real-mysql-4-1/architecture.jpg)

#### MySQL 엔진

요청된 SQL 문장을 분석하거나 최적화하는 등의 작업을 수행한다.

- 커넥션 핸들러
- SQL 파서
- 전처리기
- 옵티마이저

#### 스토리지 엔진

실제 데이터를 디스크 스토리지에 저장하거나 디스크 스토리지로부터 데이터를 읽어 오는 부분을 전담한다.

#### 핸들러 API

MySQL 엔진이 데이터를 쓰거나 읽어야 할 때는 스토리지 엔진에 쓰기 또는 읽기를 요청하는데 사용되는 API이다.

### 스레딩 구조

MySQL 서버는 프로세스 기반이 아니라 스레드 기반으로 작동하며, 크게 포그라운드 스레드(foreground thread)와 백그라운드 스레드(background thread)로 구분할 수 있다.

#### 포그라운드 스레드 (a.k.a 사용자 스레드)

최소한 서버에 접속된 클라이언트 수 만큼 존재하며, 주로 각 클라이언트 사용자가 요청하는 쿼리문장을 처리한다.

사용자가 작업을 마치고 커넥션을 종료하면 해당 커넥션을 담당하던 스레드는 스레드 캐시로 되돌아 간다. 이때 스레드 캐시에 `thread_cache_size` 시스템 변수에 설정된 개수 이상의 스레드가 존재하면 스레드를 종료시켜 일정 개수의 스레드만 존재하게 한다.

#### 백그라운드 스레드

- 인서트 버퍼를 병합하는 스레드
- **로그를 디스크로 기록하는 스레드**
- **버퍼 풀의 데이터를 디스크에 기록하는 스레드**
- 데이터를 버퍼로 읽어 오는 스레드
- 잠금이나 데드락을 모니터링하는 스레드

위 스레드 중 가장 중요한 것은 로그 스레드와 데이터를 디스크에 기록하는 쓰기 스레드 입니다.

시스템 변수 `innodb_write_io_threads`와 `innodb_read_io_threads`로 읽기, 쓰기 스레드의 개수를 지정할 수 있으며 읽기 작업은 주로 클라이언트 스레드에서 처리하기 때문에 읽기 스레드의 개수를 많이 설정할 필요가 없지만 쓰기 스레드는 많은 작업을 백그라운드로 처리하기 때문에 디스크를 최적으로 사용할 수 있을 만큼 충분히 설정하는 것이 좋다.

### 메모리 할당 및 사용 구조

MySQL에서 사영되는 메모리 공간은 <mark>글로벌 메모리 영역</mark>과 <mark>로컬 메모리 영역</mark>으로 구분할 수 있다.

#### 글로벌 메모리 영역

클라이언트 스레드의 수와 무관하게 하나의 메모리 공간만 할당되며 필요에 따라 2개 이상의 메모리 공간을 할당받을 수 있고 모든 스레드에 의해 공유된다.

- 테이블 캐시
- InnoDB 버퍼 풀
- InnoDB Adaptive Hash Index
- InnoDB Redo 로그 버퍼

#### 로컬 메모리 영역 (a.k.a 세션 메모리 영역)

클라이언트 스레드가 쿼리를 처리하는데 사용하는 메모리 영역이다.

1. 클라이언트 스레드 별로 독립적으로 할당되며 절대 공유되어 사용되지 않는다는 특징이 있다.
2. 각 쿼리의 용도별로 필요할 때만 공간이 할당되고 필요하지 않은 경우에는 MySQL이 메모리 공간을 할당조차도 하지 않을 수 있다.

대표적인 로컬 메모리 영역은 다음과 같다.

- 정렬 버퍼
- 조인 버퍼
- 바이너리 로그 캐시
- 네트워크 버퍼

### 컴포넌트

MySQL 8.0부터는 기존